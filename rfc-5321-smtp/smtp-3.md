# 3. The SMTP Procedures: An Overview

## 3.1. Session Initation

- SMTP 세션은 클라이언트가 서버에 연결, 서버가 시작 메시지로 응답 시 생성
- SMTP 프로토콜은 초기 연결을 허용하면서 메일 세션을 공식적으로 거부 가능
  - 이 경우 서버는 연결을 강제로 종료하지 않음
  - 서버는 연결 종료 전 클라이언트가 `QUIT`를 보낼 때까지 반드시 대기, 클라이언트가 세션을 정상 종료할 기회를 제공
  - 서버는 메일 세션을 수락하지 않았기 때문에 `QUIT` 이외의 모든 명령에 대해 응답코드 `503`으로 응답

## 3.2. Client Initation

- 서버가 환영 메시지를 보냈고 클라이언트가 이를 수신
- 클라이언트는 서버에 `EHLO` 명령어를 전송
  - 클라이언트의 신원(도메인) 제공
  - 클라이언트가 SMTP 확장 서비스를 처리 가능함을 표현 및 서버에게 확장 목록을 제공할 것을 요청
- 구형 SMTP이거나 확장이 불필요한 경우에는 `HELO` 사용

## 3.3 Mail Transactions

- SMTP 메일 트랜잭션은 총 3단계로 구성
  - `MAIL`: 발신자 식별 제공
  - `RCPT`: 수신자 정보 제공
  - `DATA`: 메일 데이터 전송 시작

### `MAIL`

```plain text
MAIL FROM:<reverse-path> [SP <mail-parameters> ] <CRLF>
```

- SMTP 클라이언트
  - 위의 명령을 입력하고 SMTP 서버와 양방향 통신 채널 설정
- SMTP 서버
  - 해당 명령을 받아 새로운 메일 트랜잭션이 시작되고 있음을 확인
  - 모든 버퍼 및 상태 테이블 초기화 지시
  - 발신자 주소 `<reverse-path>`를 기준으로 수락 여부를 결정
- `<reverse-path>`는 메일박스 관련 정보만 포함 가능

> 왜 이메일 주소를 "메일박스"라고 표현하는지
>
> - 메일박스는 물리적인 저장소라기 보다는 메일이 최종적으로 전달될 논리적인 목적지 주소로써의 의미
> - 메일박스는 저장소의 개념적, 논리적인 표현
> - `@`는 at sign으로 어디에 있는 누구라는 관계를 직관적으로 표현

### `RCPT`

```plain text
RCPT TO:<forward-path> [ SP <rcpt-parameters> ] <CRLF>
```

- `RCPT` 명령은 여러 번 전송 가능, 여러 클라이언트 지정 가능
- SMTP 서버
  - 수락 시 `250 OK` 응답을 반환하고 `<forward-path>`를 저장
  - `<forward-path>`가 배달 불가능한 주소인 경우 `550` 응답 반환
- SMTP 서버가 `<forward-path>`를 처리하기 위해 라우팅 및 릴레이 필요
  - 서버는 반드시 라우팅할 준비가 되어 있어야 함
  - 서버는 동시에 라우팅 경로를 무시하거나 기대되는 릴레이를 지원하지 않을 수 있고, 자신에게 오는 릴레이를 거부할 수 있음
- `<forward-path>`는 메일박스 관련 정보만 포함 가능

> 왜 주소를 sender, receiver path가 아니라 reverse, forward path라고 표현?
>
> - path라는 단어를 통해 메일의 흐름을 표현
> - forward: 메일이 정상적인 흐름으로 수신자에게 전달
> - reverse: 메일이 전달되지 못하고 실패하는 경우 반송 메일로 거꾸로 되돌아옴
> - 따라서 발신 주소와 송신 주소를 reverse, forward라고 표현함으로써 메일 전송 과정의 정방향, 역방향 흐름을 표현

### `DATA`

```plain text
DATA <CRLF>
```

- `MAIL`, `RCPT`가 모두 수락 시 `DATA` 명령 사용 가능
  - `DATA` 명령이 수락되는 경우 SMTP 서버는 `354` 중간 응답을 반환
  - 명령어 다음의 모든 줄을 발신자의 메일 텍스트로 간주
  - 오직 `.`으로만 구성된 줄을 통해 메일 데이터의 끝을 표현
  - 텍스트 끝이 성공적으로 수신 및 저장되면 SMTP 서버는 `250 OK` 응답을 전송
- `DATA` 명령어는 `MAIL`, `RCPT` 명령이 없거나 거부된 경우 실패
  - 클라이언트는 SMTP 서버로부터 `354` 응답을 수신하지 못했다면 메시지 데이터를 전송해서는 안됨
  - 서버는 일단 `354` 응답을 발행했다면 메일 트랜잭션 불완전, 자원 부족, 정책과 같은 이유에서만 명령에 실패해야 함
  - 서버 시스템은 RFC 822 메시지 형식, MINE 메시지 헤더 섹션, 메시지 본문 결함을 근거로 메시지를 거부해서는 안됨
    - 즉, 메시지 형식과 내용을 기반으로 메일 전송을 거부해서는 안됨
    - 메시지 유효성 검증은 SMTP 서버(MTA)의 몫이 아님

## 3.5 Commands for Debugging Addresses

### 3.5.1. Overview

- SMTP는 사용자 이름을 확인하거나 메일링 리스트의 내용을 얻기 위한 명령 `VRFY`, `EXPN`을 제공

> 메일링 리스트란?
>
> - 단일 주소로 메일을 전송 시 해당 리스트에 속한 수신자에게 메일이 자동으로 전달
> - 여기서 말하는 단일 주소는 실제 메일박스가 아니며 개별 수신자들을 가리키는 논리적인 메일박스
> - 단일 의사 메일박스 주소를 여러 개의 실제 목적지 메일박스 주소로 확장

- `VRFY`는 사용자 이름과 메일박스를 확인하는 명령
- `EXPN`은 메일링 리스트의 실제 구성원 목록을 반환하도록 요청하는 명령

### 3.5.4. Semantics and Applications of EXPN

> 이메일 별칭이란?
>
> - 하나의 이메일 계정(메일박스)에 여러 개의 엔드포인트(주소) 생성
> - `main@a.com`에 `sales@a.com`, `info@a.com`와 같이 호스트 이름을 변경해 별칭을 설정 가능

- `EXPN`은 메일링 리스트, 다중 대상 주소 별칭의 디버깅과 이해에 있어 유용

## 3.6. Relaying and Mail Routing

### 3.6.1. Source Routes and Relaying

- DNS에 MX 레코드가 존재하기 때문에 명시적 소스 경로를 사용할 필요가 없음
  - 여기서 말하는 명시적 소스 경로는 메일 전송 경로의 중간 호스트를 발신자가 직접 나열하여 지정하는 것을 말함
- SMTP 클라이언트는 명시적 소스 경로를 생성해서는 안됨
- SMTP 서버는 소스 경로를 지정하는 주소를 거부할 수 있으며 해당 정보를 무시하고 최종 목적지로 단순히 전송할 수 있음

### 3.6.2. Mail eXchange Records and Relaying

- 릴레이 SMTP 서버는 최종 전송 서버가 아니며 MX 레코드의 대상이 됨
- SMTP 서버는 메일 릴레이 작업을 수락하거나 거부할 수 있음
  - 정책상의 이유로 거부하는 경우 `550` 반환

### 3.6.3. Message Submission Servers as Relays

- MX 레코드는 게이트웨이 SMTP 서버를 가리킬 수 있으며 최종 전달 시스템만을 가리키는 것이 아님
- SMTP 서버가 릴레이 작업을 수락했지만 메일을 전달할 수 없음을 발견할 수 있음
  - 이 경우, 전달 불가능한 메일에 대한 알림 메시지를 작성해 메일 발신자에게 전송

## 3.7. Mail Gatewaying

- 전송 서비스 간의 변환이 필요한 경우 게이트웨이 SMTP 서버 필요
- 서로 다른 메일 환경(메일 형식, 프로토콜) 간의 메일 게이트웨잉은 복잡하며 표준화가 어렵지만 몇 가지 일반적인 요구사항이 존재

## 3.8. Terminating Sessions and Connections

- 클라이언트가 `QUIT` 명령을 전송하면 서버는 긍정적인 응답코드를 보낸 후 연결을 닫음
- 서버는 아래의 경우를 제외하고는 정상적인 운영 상황에서 의도적으로 연결을 닫아서는 안됨
  - `QUIT` 명령을 수신하고 `221` 응답을 보낸 후
  - SMTP 서비스를 종료할 필요가 있음을 감지하고 `421` 응답 코드를 반환한 후
    - 외부 수단으로 인해 SMTP 서버가 강제 종료되는 경우 `421`을 보내려고 시도해야 함
  - 클라이언트가 명령 또는 데이터를 전송하기를 기다리는 동안 타임 아웃이 발생한 경우
- 이해할 수 없는 명령에 대한 응답으로 서버가 연결을 닫아서는 안됨
  - 서버는 알 수 없는 명령에 대해 `500` 응답을 보내고 클라이언트로부터 추가 지시를 기다려야 함

## 3.9. Mailing Lists and Aliases

- SMTP 지원 호스트는 다중 배달을 위한 주소 확장의 별칭, 리스트 모델을 모두 제공해야 함
- 의사 메일박스의 사용
  - 단일 메시지를 여러 목적지로 배달하기 위해 사용
  - 의사 메일박스가 대상 메일박스 주소 목록으로 확장
  - 서버는 해당 주소 목록을 변형하거나 제거하지 않고 그대로 활용해야 함
  - 의사 메일박스는 확장 규칙에 따라 별칭과 리스트로 구분

### 3.9.1. Alias

- 봉투의 의사 메일박스 주소를 확장된 각 주소로 단순하게 교체 및 해당 주소로 포워딩
- 봉투의 나머지 부분, 본문은 변경되지 않음

### 3.9.2 List

- 봉투의 의사 메일박스 주소를 확장된 각 주소로 교체
  - 봉투의 반송 주소(`reverse-path`)를 메시지 발신자가 아닌 리스트 관리자로 교체
  - 별칭 모델과의 가장 큰 차이는 반송 주소 변경
  - 메일링 리스트는 포워딩보다 재분배 방식으로 작동
- 메시지와 봉투에 광범위한 수정을 하는 메일링 리스트도 존재하나, 이는 MTA가 아닌 MUA로 간주되어야 함

> SMTP 봉투란?
>
> - SMTP는 봉투와 컨텐츠라는 두 요소로 나뉨
> - 봉투는 SMTP 명령 `MAIL` `RCPT`에서 입력하는 발신자, 수신자를 의미
> - 컨텐츠는 SMTP 명령 `DATA`에서 입력하는 내용으로 RFC 5322에서 해당 형식이 정의됨, 헤더 필드와 본문으로 구성
